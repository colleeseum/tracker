name: Deploy to Firebase

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Inject build version into client
        env:
          VERSION: ${{ github.run_number }}
        run: |
          python3 - <<'PY'
import os
from pathlib import Path
path = Path("public/index.html")
text = path.read_text()
marker = 'data-app-version="__APP_VERSION__"'
version = os.environ.get("VERSION", "dev")
if marker not in text:
    raise SystemExit("Version marker not found in public/index.html")
path.write_text(text.replace(marker, f'data-app-version="{version}"', 1))
PY

      - name: Install Functions dependencies
        run: npm install --prefix functions

      - name: Install Firebase CLI
        run: npm install -g firebase-tools

      - name: Deploy to Firebase
        env:
          FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        run: firebase deploy --project tracker-187c5 --only hosting,functions,firestore
